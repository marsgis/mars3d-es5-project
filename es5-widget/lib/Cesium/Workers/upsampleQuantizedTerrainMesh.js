define(["./AttributeCompression-c52e2037","./Transforms-037fb660","./Matrix2-09da682a","./when-229515d6","./TerrainEncoding-979d5452","./IndexDatatype-b10faa0b","./RuntimeError-ffe03243","./ComponentDatatype-17b06483","./OrientedBoundingBox-e84e3ad6","./createTaskProcessorWorker","./combine-8ce3f24b","./WebGLConstants-4e26b85a","./EllipsoidTangentPlane-0bd319d3","./AxisAlignedBoundingBox-5b1a95b0","./IntersectionTests-09df2d6e","./Plane-5dd27ab8"],(function(e,i,t,n,s,r,h,u,o,a,d,p,f,l,g,c){"use strict";var m={clipTriangleAtAxisAlignedThreshold:function(e,i,t,s,r,h){var u,o,a;n.defined(h)?h.length=0:h=[],i?(u=t<e,o=s<e,a=r<e):(u=t>e,o=s>e,a=r>e);var d,p,f,l,g,c,m=u+o+a;return 1===m?u?(d=(e-t)/(s-t),p=(e-t)/(r-t),h.push(1),h.push(2),1!==p&&(h.push(-1),h.push(0),h.push(2),h.push(p)),1!==d&&(h.push(-1),h.push(0),h.push(1),h.push(d))):o?(f=(e-s)/(r-s),l=(e-s)/(t-s),h.push(2),h.push(0),1!==l&&(h.push(-1),h.push(1),h.push(0),h.push(l)),1!==f&&(h.push(-1),h.push(1),h.push(2),h.push(f))):a&&(g=(e-r)/(t-r),c=(e-r)/(s-r),h.push(0),h.push(1),1!==c&&(h.push(-1),h.push(2),h.push(1),h.push(c)),1!==g&&(h.push(-1),h.push(2),h.push(0),h.push(g))):2===m?u||t===e?o||s===e?a||r===e||(p=(e-t)/(r-t),f=(e-s)/(r-s),h.push(2),h.push(-1),h.push(0),h.push(2),h.push(p),h.push(-1),h.push(1),h.push(2),h.push(f)):(c=(e-r)/(s-r),d=(e-t)/(s-t),h.push(1),h.push(-1),h.push(2),h.push(1),h.push(c),h.push(-1),h.push(0),h.push(1),h.push(d)):(l=(e-s)/(t-s),g=(e-r)/(t-r),h.push(0),h.push(-1),h.push(1),h.push(0),h.push(l),h.push(-1),h.push(2),h.push(0),h.push(g)):3!==m&&(h.push(0),h.push(1),h.push(2)),h},computeBarycentricCoordinates:function(e,i,s,r,h,u,o,a,d){var p=s-o,f=o-h,l=u-a,g=r-a,c=1/(l*p+f*g),m=i-a,x=e-o,v=(l*x+f*m)*c,w=(-g*x+p*m)*c,C=1-v-w;return n.defined(d)?(d.x=v,d.y=w,d.z=C,d):new t.Cartesian3(v,w,C)},computeLineSegmentLineSegmentIntersection:function(e,i,s,r,h,u,o,a,d){var p=(a-u)*(s-e)-(o-h)*(r-i);if(0!==p){var f=((o-h)*(i-u)-(a-u)*(e-h))/p,l=((s-e)*(i-u)-(r-i)*(e-h))/p;return f>=0&&f<=1&&l>=0&&l<=1?(n.defined(d)||(d=new t.Cartesian2),d.x=e+f*(s-e),d.y=i+f*(r-i),d):void 0}}},x=32767,v=16383,w=[],C=[],B=[],y=new t.Cartographic,b=new t.Cartesian3,I=[],A=[],T=[],z=[],M=[],N=new t.Cartesian3,V=new i.BoundingSphere,E=new o.OrientedBoundingBox,R=new t.Cartesian2,H=new t.Cartesian3;function O(){this.vertexBuffer=void 0,this.index=void 0,this.first=void 0,this.second=void 0,this.ratio=void 0}O.prototype.clone=function(e){return n.defined(e)||(e=new O),e.uBuffer=this.uBuffer,e.vBuffer=this.vBuffer,e.heightBuffer=this.heightBuffer,e.normalBuffer=this.normalBuffer,e.index=this.index,e.first=this.first,e.second=this.second,e.ratio=this.ratio,e},O.prototype.initializeIndexed=function(e,i,t,n,s){this.uBuffer=e,this.vBuffer=i,this.heightBuffer=t,this.normalBuffer=n,this.index=s,this.first=void 0,this.second=void 0,this.ratio=void 0},O.prototype.initializeFromClipResult=function(e,i,t){var n=i+1;return-1!==e[i]?t[e[i]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=t[e[n]],++n,this.second=t[e[n]],++n,this.ratio=e[n],++n),n},O.prototype.getKey=function(){return this.isIndexed()?this.index:JSON.stringify({first:this.first.getKey(),second:this.second.getKey(),ratio:this.ratio})},O.prototype.isIndexed=function(){return n.defined(this.index)},O.prototype.getH=function(){return n.defined(this.index)?this.heightBuffer[this.index]:u.CesiumMath.lerp(this.first.getH(),this.second.getH(),this.ratio)},O.prototype.getU=function(){return n.defined(this.index)?this.uBuffer[this.index]:u.CesiumMath.lerp(this.first.getU(),this.second.getU(),this.ratio)},O.prototype.getV=function(){return n.defined(this.index)?this.vBuffer[this.index]:u.CesiumMath.lerp(this.first.getV(),this.second.getV(),this.ratio)};var S=new t.Cartesian2,U=-1,F=[new t.Cartesian3,new t.Cartesian3],P=[new t.Cartesian3,new t.Cartesian3];function D(i,n){++U;var s=F[U],r=P[U];return s=e.AttributeCompression.octDecode(i.first.getNormalX(),i.first.getNormalY(),s),r=e.AttributeCompression.octDecode(i.second.getNormalX(),i.second.getNormalY(),r),b=t.Cartesian3.lerp(s,r,i.ratio,b),t.Cartesian3.normalize(b,b),e.AttributeCompression.octEncode(b,n),--U,n}O.prototype.getNormalX=function(){return n.defined(this.index)?this.normalBuffer[2*this.index]:(S=D(this,S)).x},O.prototype.getNormalY=function(){return n.defined(this.index)?this.normalBuffer[2*this.index+1]:(S=D(this,S)).y};var W=[];function X(e,i,t,s,r,h,u,o,a){if(0!==u.length){for(var d=0,p=0;p<u.length;)p=W[d++].initializeFromClipResult(u,p,o);for(var f=0;f<d;++f){var l=W[f];if(l.isIndexed())l.newIndex=h[l.index],l.uBuffer=e,l.vBuffer=i,l.heightBuffer=t,a&&(l.normalBuffer=s);else{var g=l.getKey();if(n.defined(h[g]))l.newIndex=h[g];else{var c=e.length;e.push(l.getU()),i.push(l.getV()),t.push(l.getH()),a&&(s.push(l.getNormalX()),s.push(l.getNormalY())),l.newIndex=c,h[g]=c}}}3===d?(r.push(W[0].newIndex),r.push(W[1].newIndex),r.push(W[2].newIndex)):4===d&&(r.push(W[0].newIndex),r.push(W[1].newIndex),r.push(W[2].newIndex),r.push(W[0].newIndex),r.push(W[2].newIndex),r.push(W[3].newIndex))}}return W.push(new O),W.push(new O),W.push(new O),W.push(new O),a((function(e,n){var h=e.isEastChild,a=e.isNorthChild,d=h?v:0,p=h?x:v,f=a?v:0,l=a?x:v,g=I,c=A,S=T,U=M;g.length=0,c.length=0,S.length=0,U.length=0;var F=z;F.length=0;var P={},D=e.vertices,W=e.indices;W=W.subarray(0,e.indexCountWithoutSkirts);var k,K,L,Y,_,G=s.TerrainEncoding.clone(e.encoding),J=G.hasVertexNormals,Z=0,j=e.vertexCountWithoutSkirts,q=e.minimumHeight,Q=e.maximumHeight,$=new Array(j),ee=new Array(j),ie=new Array(j),te=J?new Array(2*j):void 0;for(K=0,L=0;K<j;++K,L+=2){var ne=G.decodeTextureCoordinates(D,K,R);if(k=G.decodeHeight(D,K),Y=u.CesiumMath.clamp(ne.x*x|0,0,x),_=u.CesiumMath.clamp(ne.y*x|0,0,x),ie[K]=u.CesiumMath.clamp((k-q)/(Q-q)*x|0,0,x),Y<20&&(Y=0),_<20&&(_=0),x-Y<20&&(Y=x),x-_<20&&(_=x),$[K]=Y,ee[K]=_,J){var se=G.getOctEncodedNormal(D,K,H);te[L]=se.x,te[L+1]=se.y}(h&&Y>=v||!h&&Y<=v)&&(a&&_>=v||!a&&_<=v)&&(P[K]=Z,g.push(Y),c.push(_),S.push(ie[K]),J&&(U.push(te[L]),U.push(te[L+1])),++Z)}var re=[];re.push(new O),re.push(new O),re.push(new O);var he,ue=[];for(ue.push(new O),ue.push(new O),ue.push(new O),K=0;K<W.length;K+=3){var oe=W[K],ae=W[K+1],de=W[K+2],pe=$[oe],fe=$[ae],le=$[de];re[0].initializeIndexed($,ee,ie,te,oe),re[1].initializeIndexed($,ee,ie,te,ae),re[2].initializeIndexed($,ee,ie,te,de);var ge=m.clipTriangleAtAxisAlignedThreshold(v,h,pe,fe,le,w);(he=0)>=ge.length||((he=ue[0].initializeFromClipResult(ge,he,re))>=ge.length||(he=ue[1].initializeFromClipResult(ge,he,re))>=ge.length||(he=ue[2].initializeFromClipResult(ge,he,re),X(g,c,S,U,F,P,m.clipTriangleAtAxisAlignedThreshold(v,a,ue[0].getV(),ue[1].getV(),ue[2].getV(),C),ue,J),he<ge.length&&(ue[2].clone(ue[1]),ue[2].initializeFromClipResult(ge,he,re),X(g,c,S,U,F,P,m.clipTriangleAtAxisAlignedThreshold(v,a,ue[0].getV(),ue[1].getV(),ue[2].getV(),C),ue,J))))}var ce=h?-32767:0,me=a?-32767:0,xe=[],ve=[],we=[],Ce=[],Be=Number.MAX_VALUE,ye=-Be,be=B;be.length=0;var Ie=t.Ellipsoid.clone(e.ellipsoid),Ae=t.Rectangle.clone(e.childRectangle),Te=Ae.north,ze=Ae.south,Me=Ae.east,Ne=Ae.west;for(Me<Ne&&(Me+=u.CesiumMath.TWO_PI),K=0;K<g.length;++K)(Y=Math.round(g[K]))<=d?(xe.push(K),Y=0):Y>=p?(we.push(K),Y=x):Y=2*Y+ce,g[K]=Y,(_=Math.round(c[K]))<=f?(ve.push(K),_=0):_>=l?(Ce.push(K),_=x):_=2*_+me,c[K]=_,(k=u.CesiumMath.lerp(q,Q,S[K]/x))<Be&&(Be=k),k>ye&&(ye=k),S[K]=k,y.longitude=u.CesiumMath.lerp(Ne,Me,Y/x),y.latitude=u.CesiumMath.lerp(ze,Te,_/x),y.height=k,Ie.cartographicToCartesian(y,b),be.push(b.x),be.push(b.y),be.push(b.z);var Ve=i.BoundingSphere.fromVertices(be,t.Cartesian3.ZERO,3,V),Ee=o.OrientedBoundingBox.fromRectangle(Ae,Be,ye,Ie,E),Re=new s.EllipsoidalOccluder(Ie).computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid(Ve.center,be,3,Ve.center,Be,N),He=ye-Be,Oe=new Uint16Array(g.length+c.length+S.length);for(K=0;K<g.length;++K)Oe[K]=g[K];var Se=g.length;for(K=0;K<c.length;++K)Oe[Se+K]=c[K];for(Se+=c.length,K=0;K<S.length;++K)Oe[Se+K]=x*(S[K]-Be)/He;var Ue,Fe=r.IndexDatatype.createTypedArray(g.length,F);if(J){var Pe=new Uint8Array(U);n.push(Oe.buffer,Fe.buffer,Pe.buffer),Ue=Pe.buffer}else n.push(Oe.buffer,Fe.buffer);return{vertices:Oe.buffer,encodedNormals:Ue,indices:Fe.buffer,minimumHeight:Be,maximumHeight:ye,westIndices:xe,southIndices:ve,eastIndices:we,northIndices:Ce,boundingSphere:Ve,orientedBoundingBox:Ee,horizonOcclusionPoint:Re}}))}));
